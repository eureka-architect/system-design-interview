# 📌 Facebook의 Memcached 확장 및 최적화

## 📖 개요
- **Memcached**는 Facebook에서 **대규모 분산 키-값 저장소**의 핵심 요소로 활용됨.
- Facebook의 인프라는 **초당 수십억 개의 요청을 처리**하며, **수조 개의 항목을 저장**하여 10억 명 이상의 사용자에게 빠른 데이터 제공.
- Memcached를 단순한 인메모리 캐싱 솔루션에서 **지리적으로 분산된 대규모 시스템**으로 확장.

---

## 🚀 Facebook에서의 Memcached 사용 방식
- **Look-aside Cache 방식**: 
  - 웹 서버가 Memcached에서 데이터를 조회하고, **캐시 미스 발생 시 DB에서 가져온 후 다시 Memcached에 저장**.
- **쓰기 경로 최적화**:
  - DB 업데이트 후 Memcached의 데이터를 삭제하는 방식(`Delete` 사용)으로 데이터 일관성 유지.

---

## 🏗️ 확장 과정과 주요 과제
- 단일 클러스터에서 **전 세계적으로 분산된 클러스터**로 확장.
- 규모가 커질수록 **데이터 일관성, 네트워크 부하, 장애 대응** 등의 문제가 발생.
- **주요 개선 사항**:
  1. **데이터 일관성 보장**: SQL 트랜잭션과 연동하여 캐시 무효화 (`mcsqueal` 시스템).
  2. **네트워크 최적화**: 요청을 그룹화하여 네트워크 부하 감소.
  3. **장애 대응**: `Gutter Pool`이라는 별도의 서버 그룹을 활용해 일부 캐시 서버 장애 시 DB 부하 방지.

---

## ⚡ 성능 최적화 기법
- **UDP 활용**: 요청 레이턴시를 낮추기 위해 **UDP를 사용하여 Memcached와 통신**.
- **병렬 요청 및 배칭**: 요청을 일괄 처리하여 성능 향상.
- **Incast Congestion 해결**: TCP 슬라이딩 윈도우 방식으로 **동시 요청 부하 완화**.
- **적응형 슬랩 할당기(Adaptive Slab Allocator)**: 캐시 메모리 사용을 최적화하여 **메모리 낭비 최소화**.

---

## 🔧 장애 대응 전략
- **Gutter Pool**을 사용하여 일부 캐시 서버가 실패해도 DB로 가는 부하를 최소화.
- **콜드 클러스터 워밍업**: 새로운 클러스터가 추가될 때 기존 캐시에서 데이터를 가져와 빠르게 활성화.

---

## 🌍 글로벌 분산 및 데이터 일관성 유지
- **Master-Replica Region 아키텍처**: 하나의 **Master Region에서 데이터를 관리하고, 다른 지역으로 복제**.
- **Replication Lag 문제 해결**: `Remote Marker`를 사용하여 **복제 지연으로 인해 오래된 데이터가 캐시에 남아 있는 것 방지**.

---

## 🖥️ 단일 서버 성능 최적화
- **멀티스레드 지원**: 글로벌 락 대신 **세분화된 락을 활용하여 성능 3배 향상**.
- **Transient Item Cache**: **짧은 생명 주기의 항목을 효과적으로 관리**하여 메모리 낭비 방지.

---

## ✅ 결론
- Facebook은 Memcached를 단순한 캐시 시스템이 아니라 **대규모 분산 키-값 저장소**로 발전시킴.
- **캐시와 영구 저장소를 분리하여 독립적으로 확장 가능하도록 설계**.
- 운영 효율성을 극대화하고, 성능 및 장애 대응 기능을 지속적으로 개선.

---

📌 **Reference**
- [Scaling Memcached at Facebook - USENIX Paper](https://www.usenix.org/conference/nsdi13/technical-sessions/presentation/nishtala)
